#!/bin/bash
# ==========================================
# ðŸ§  Sing-box IPv4 TProxy ä¸€é”®é…ç½®è„šæœ¬ (å¢žå¼ºç‰ˆ)
# 
# ä½œè€…: shangkouyou Duang Scu
# ä¼˜åŒ–: Antigravity
# ç‰ˆæœ¬: v1.6 (Strict Interface Binding & Docker Fix)
#
# æ›´æ–°æ—¥å¿—:
# - v1.6: 
#   - å¼ºåˆ¶ç»‘å®š LAN æŽ¥å£ï¼Œé˜²æ­¢å®¿ä¸»æœºæµé‡å›žçŽ¯
#   - æ˜Žç¡®è±å… Docker é»˜è®¤ç½‘æ®µ (172.16.0.0/12 ç­‰)
#   - ä¼˜åŒ–ä¾èµ–æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
# ==========================================

# æ£€æŸ¥ bash çŽ¯å¢ƒ
if [ -z "$BASH_VERSION" ]; then
    echo "âš ï¸  æ­¤è„šæœ¬éœ€è¦ bash çŽ¯å¢ƒã€‚æ­£åœ¨å°è¯•åˆ‡æ¢..."
    exec bash "$0" "$@"
fi

set -e
LOG_FILE="/var/log/tproxy-setup.log"
TPROXY_DIR="/etc/tproxy"
TPROXY_SCRIPT="$TPROXY_DIR/tproxy.sh"
TPROXY_PORT=9420
# é»˜è®¤ mark å€¼
TPROXY_MARK=0x2333
TABLE_ID=100
DOCKER_PORT=9277
CUSTOM_CHAIN="TPROXY_CHAIN"

# --- è¾…åŠ©å‡½æ•° ---
log() {
    echo "[$(date '+%F %T')] $1" | tee -a "$LOG_FILE"
}

# æ£€æµ‹ Mihomo routing-mark
detect_mihomo_routing_mark() {
    local mihomo_config="/etc/mihomo/config.yaml"
    if [ -f "$mihomo_config" ]; then
        local routing_mark=$(grep -E "^routing-mark:" "$mihomo_config" 2>/dev/null | awk '{print $2}' | tr -d ' ' | head -n1)
        if [ -n "$routing_mark" ] && [[ "$routing_mark" =~ ^[0-9]+$ ]]; then
            printf "0x%X" "$routing_mark" 2>/dev/null
            return 0
        fi
    fi
    echo "0x2333"
}

# æ£€æµ‹ä¸»ç½‘å¡ (LAN æŽ¥å£)
detect_lan_interface() {
    # ä¼˜å…ˆæ£€æµ‹é»˜è®¤è·¯ç”±æŽ¥å£
    local iface=$(ip -4 route show default 2>/dev/null | grep -o 'dev [^ ]*' | awk '{print $2}' | head -n1)
    if [ -z "$iface" ]; then
        # å¤‡ç”¨ï¼šæ£€æµ‹éž lo çš„ç¬¬ä¸€ä¸ªæŽ¥å£
        iface=$(ip -4 link show | grep -E '^[0-9]+:' | grep -v 'lo:' | head -n1 | awk -F': ' '{print $2}' | awk '{print $1}')
    fi
    echo "$iface"
}

# --- ä¸»é€»è¾‘ ---

log "ðŸš€ å¼€å§‹é…ç½® IPv4 TProxy çŽ¯å¢ƒ (v1.6)..."

# 1. çŽ¯å¢ƒå‡†å¤‡
mkdir -p "$TPROXY_DIR"

# æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
MISSING_PKGS=()
for cmd in iptables ip netstat; do
    if ! command -v $cmd > /dev/null 2>&1; then
        case $cmd in
            iptables) MISSING_PKGS+=("iptables") ;;
            ip) MISSING_PKGS+=("iproute2") ;;
            netstat) MISSING_PKGS+=("net-tools") ;;
        esac
    fi
done

if [ ${#MISSING_PKGS[@]} -gt 0 ]; then
    log "ðŸ“¦ å®‰è£…ç¼ºå¤±ä¾èµ–: ${MISSING_PKGS[*]}"
    if [ -f /etc/alpine-release ]; then
        apk update && apk add "${MISSING_PKGS[@]}"
    elif [ -f /etc/debian_version ]; then
        apt-get update && apt-get install -y "${MISSING_PKGS[@]}"
    elif [ -f /etc/redhat-release ]; then
        yum install -y "${MISSING_PKGS[@]}"
    fi
fi

# 2. å†…æ ¸æ¨¡å—å’Œå‚æ•°
for mod in xt_TPROXY nf_tproxy_ipv4; do
    modprobe $mod 2>/dev/null || true
done

sysctl -w net.ipv4.ip_forward=1 > /dev/null
if ! grep -q '^net.ipv4.ip_forward' /etc/sysctl.conf 2>/dev/null; then
    echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
fi

# 3. åŒæ­¥ Mark
DETECTED_MARK=$(detect_mihomo_routing_mark)
if [ "$DETECTED_MARK" != "$TPROXY_MARK" ]; then
    TPROXY_MARK="$DETECTED_MARK"
    log "âœ… åŒæ­¥ Mihomo routing-mark: $TPROXY_MARK"
fi

# 4. ç”Ÿæˆ TProxy è„šæœ¬
cat > "$TPROXY_SCRIPT" <<EOF
#!/bin/bash
# IPv4 TProxy Script (Generated by setup-tproxy-ipv4.sh v1.6)

LOG_FILE="/var/log/tproxy.log"
TPROXY_PORT=$TPROXY_PORT
TPROXY_MARK=$TPROXY_MARK
TABLE_ID=$TABLE_ID
DOCKER_PORT=$DOCKER_PORT
CHAIN_NAME="$CUSTOM_CHAIN"

log() {
    echo "[\$(date '+%F %T')] \$1" | tee -a "\$LOG_FILE"
}

wait_for_mihomo() {
    local max_wait=60
    local waited=0
    log "â³ ç­‰å¾… Mihomo å¯åŠ¨..."
    while [ \$waited -lt \$max_wait ]; do
        if netstat -tuln 2>/dev/null | grep -q ":\$TPROXY_PORT "; then
            log "âœ… Mihomo å·²å°±ç»ª"
            return 0
        fi
        sleep 2
        waited=\$((waited + 2))
    done
    log "âŒ ç­‰å¾… Mihomo è¶…æ—¶"
    return 1
}

# --- æ ¸å¿ƒé€»è¾‘ ---

log "ðŸš€ å¯åŠ¨ TProxy é…ç½®..."

if ! wait_for_mihomo; then
    exit 1
fi

# è‡ªåŠ¨æ£€æµ‹ LAN æŽ¥å£
LAN_IF="\$(ip -4 route show default 2>/dev/null | grep -o 'dev [^ ]*' | awk '{print \$2}' | head -n1)"
[ -z "\$LAN_IF" ] && LAN_IF="\$(ip -4 link show | grep -E '^[0-9]+:' | grep -v 'lo:' | head -n1 | awk -F': ' '{print \$2}' | awk '{print \$1}')"

log "â„¹ï¸  LAN æŽ¥å£: \$LAN_IF"

# èŽ·å–æœ¬æœº IP ç”¨äºŽè±å…
MAIN_IP="\$(ip -4 addr show "\$LAN_IF" 2>/dev/null | grep 'inet ' | awk '{print \$2}' | cut -d/ -f1 | head -n1)"

# æ¸…ç†æ—§è§„åˆ™
iptables -t mangle -D PREROUTING -i "\$LAN_IF" -j \$CHAIN_NAME 2>/dev/null || true
iptables -t mangle -D PREROUTING -j \$CHAIN_NAME 2>/dev/null || true
iptables -t mangle -F \$CHAIN_NAME 2>/dev/null || true
iptables -t mangle -X \$CHAIN_NAME 2>/dev/null || true
ip rule del fwmark \$TPROXY_MARK table \$TABLE_ID 2>/dev/null || true
ip route flush table \$TABLE_ID 2>/dev/null || true

# åˆ›å»ºæ–°é“¾
iptables -t mangle -N \$CHAIN_NAME

# rule 1: è±å…æœ¬æœºå’Œå¹¿æ’­
iptables -t mangle -A \$CHAIN_NAME -d 127.0.0.0/8 -j RETURN
iptables -t mangle -A \$CHAIN_NAME -d 255.255.255.255 -j RETURN
if [ -n "\$MAIN_IP" ]; then
    iptables -t mangle -A \$CHAIN_NAME -d "\$MAIN_IP" -j RETURN
    iptables -t mangle -A \$CHAIN_NAME -s "\$MAIN_IP" -j RETURN
fi

# rule 2: è±å…å±€åŸŸç½‘ç§æœ‰æ®µ (LANäº’è®¿)
iptables -t mangle -A \$CHAIN_NAME -d 10.0.0.0/8 -j RETURN
iptables -t mangle -A \$CHAIN_NAME -d 172.16.0.0/12 -j RETURN
iptables -t mangle -A \$CHAIN_NAME -d 192.168.0.0/16 -j RETURN

# rule 3: è±å… Docker ç½‘æ®µ (å…³é”®ï¼šé˜²æ­¢å®¹å™¨æµé‡è¢«è¯¯åŠ«æŒ)
# é»˜è®¤ Docker ç½‘æ¡¥é€šå¸¸æ˜¯ 172.17.0.0/16ï¼Œå·²åŒ…å«åœ¨ 172.16.0.0/12 ä¸­
# å¦‚æžœæœ‰å…¶ä»–è‡ªå®šä¹‰ç½‘æ®µï¼Œè¯·åœ¨æ­¤æ·»åŠ 

# rule 4: è±å…ç‰¹å®šç«¯å£
iptables -t mangle -A \$CHAIN_NAME -p tcp --dport \$DOCKER_PORT -j RETURN
iptables -t mangle -A \$CHAIN_NAME -p udp --dport \$DOCKER_PORT -j RETURN

# rule 5: UDP 443 QUIC é˜»æ–­ (å¼ºåˆ¶å›žè½ TCP)
iptables -t mangle -A \$CHAIN_NAME -p udp --dport 443 -j DROP

# rule 6: TProxy è½¬å‘
iptables -t mangle -A \$CHAIN_NAME -p tcp -j TPROXY --on-port \$TPROXY_PORT --tproxy-mark \$TPROXY_MARK
iptables -t mangle -A \$CHAIN_NAME -p udp -j TPROXY --on-port \$TPROXY_PORT --tproxy-mark \$TPROXY_MARK

# æŒ‚è½½åˆ° PREROUTING (ä»…é’ˆå¯¹ LAN æŽ¥å£å…¥ç«™æµé‡)
# è¿™æ˜¯ "ç½‘å…³æ¨¡å¼" çš„æ ¸å¿ƒï¼šåªå¤„ç†è¿›å…¥ LAN å£çš„æµé‡ï¼Œä¸å¤„ç†æœ¬æœºå‘å‡ºçš„æµé‡(OUTPUT)
if [ -n "\$LAN_IF" ]; then
    iptables -t mangle -I PREROUTING -i "\$LAN_IF" -j \$CHAIN_NAME
    log "âœ… å·²å°† TProxy æŒ‚è½½åˆ°æŽ¥å£ \$LAN_IF"
else
    # æ— æ³•æ£€æµ‹æŽ¥å£æ—¶å›žé€€åˆ°å…¨å±€ (ä¸æŽ¨èï¼Œä½†ä½œä¸ºä¿åº•)
    iptables -t mangle -I PREROUTING -j \$CHAIN_NAME
    log "âš ï¸  æœªæ£€æµ‹åˆ° LAN æŽ¥å£ï¼ŒæŒ‚è½½åˆ°å…¨å±€ PREROUTING"
fi

# ç­–ç•¥è·¯ç”± (å¤„ç†è¢« TProxy æ ‡è®°çš„æµé‡)
ip rule add fwmark \$TPROXY_MARK table \$TABLE_ID
ip route add local default dev lo table \$TABLE_ID

log "âœ… IPv4 TProxy é…ç½®å®Œæˆ"
EOF

chmod +x "$TPROXY_SCRIPT"

# 5. åˆ›å»ºç³»ç»ŸæœåŠ¡

# æ£€æµ‹ç³»ç»Ÿç±»åž‹ç”ŸæˆæœåŠ¡æ–‡ä»¶
if [ -f /etc/alpine-release ]; then
    # Alpine OpenRC
    cat > /etc/init.d/tproxy <<EOFRC
#!/sbin/openrc-run
description="Sing-box IPv4 TProxy Service"
command="$TPROXY_SCRIPT"
command_background="yes"
pidfile="/run/tproxy.pid"

depend() {
    need net mihomo
    after firewall
}

start() {
    ebegin "Starting TProxy"
    \$command
    eend \$?
}

stop() {
    ebegin "Stopping TProxy"
    iptables -t mangle -F $CUSTOM_CHAIN 2>/dev/null
    iptables -t mangle -D PREROUTING -j $CUSTOM_CHAIN 2>/dev/null
    # æ³¨æ„ï¼šå¦‚æžœæŒ‡å®šäº†æŽ¥å£ï¼Œè¿˜éœ€è¦æ¸…ç†å¸¦æŽ¥å£å‚æ•°çš„è§„åˆ™ï¼Œè¿™é‡Œç®€å•å¤„ç†
    # å®žé™…ä¸Šè„šæœ¬é‡æ–°è¿è¡Œæ—¶ä¼šæ¸…ç†
    eend 0
}
EOFRC
    chmod +x /etc/init.d/tproxy
    rc-update add tproxy default
    rc-service tproxy restart
else
    # Systemd
    cat > /etc/systemd/system/tproxy.service <<EOFSD
[Unit]
Description=Sing-box IPv4 TProxy Service
After=network.target mihomo.service
Requires=mihomo.service

[Service]
Type=oneshot
ExecStart=$TPROXY_SCRIPT
RemainAfterExit=yes
ExecStop=/usr/bin/iptables -t mangle -F $CUSTOM_CHAIN
ExecStop=/usr/bin/ip rule del fwmark $TPROXY_MARK table $TABLE_ID

[Install]
WantedBy=multi-user.target
EOFSD
    systemctl daemon-reload
    systemctl enable tproxy
    systemctl restart tproxy
fi

log "ðŸŽ‰ TProxy å®‰è£…å¹¶å¯åŠ¨æˆåŠŸï¼"
log "   å®¢æˆ·ç«¯ç½‘å…³è¯·æŒ‡å‘æœ¬æœº IP"
